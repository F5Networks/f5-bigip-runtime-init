image: ${ARTIFACTORY_SERVER}/dockerhub-remote/node:8

stages:
    - process
    - test
    - build
    - functional_test_publish
    - functional_test_init
    - functional_test_execute
    - functional_test_cleanup
    - functional_test_cleanup_container
    - publish
    - release_publish
    - release_trigger_template_tests

.helpers: &helpers |
    function validate () {
        "$@"
        if [[ $? -ne 0 ]]; then exit 1; fi
    }

before_script:
    - *helpers

variables:
    ARM_CLIENT_ID: "$AZURE_COMMERCIAL_CLIENT_ID"
    ARM_CLIENT_SECRET: "$AZURE_COMMERCIAL_CLIENT_SECRET"
    ARM_SUBSCRIPTION_ID: "$AZURE_COMMERCIAL_SUBSCRIPTION_ID"
    ARM_TENANT_ID: "$AZURE_COMMERCIAL_TENANT_ID"
    TF_VAR_AZURE_TENANT_ID: "$AZURE_COMMERCIAL_TENANT_ID"
    TF_VAR_AZURE_OBJECT_ID: "$AZURE_COMMERCIAL_OBJECT_ID"
    AWS_ACCESS_KEY_ID: "$AWS_ACCESS_KEY_ID"
    AWS_SECRET_ACCESS_KEY: "$AWS_SECRET_ACCESS_KEY"
    TF_VAR_AWS_DEFAULT_DOMAIN: "$AWS_DEFAULT_DOMAIN"
    TF_VAR_AWS_DEFAULT_REGION: "$AWS_DEFAULT_REGION"
    TF_VAR_AZURE_OFFER: "$AZURE_OFFER"
    TF_VAR_AZURE_SKU: "$AZURE_SKU"
    TF_VAR_DOMAIN: 'us'
    TF_VAR_AZURE_BIGIP_VERSION: "$AZURE_BIGIP_VERSION"
    GIT_SECRETS_VERSION: '1.3.0'
    GIT_SECRETS_PKG_URL: "https://github.com/awslabs/git-secrets/archive/${GIT_SECRETS_VERSION}.tar.gz"


# Cleanup development RPM's on CDN when branch no longer present on gitlab
cleanup_publish_rpms_dev_cdn:
    stage: process
    only:
        variables:
            - $CLEANUP_DEVELOP_CDN == "true"
    except:
        variables:
            - $RUN_FUNCTIONAL_TESTS == "true"
            - $PUBLISH_RPM == "true"
    script:
        # install jq
        - apt-get update
        - apt-get install -y jq
        # find branches in project and cdn
        - CDN_FOLDER="f5-bigip-runtime-init"
        - AUTH_OPTS="--username ${CDN_SVC_ACCOUNT_USER} --password ${CDN_SVC_ACCOUNT_PWD} --non-interactive"
        - svn co ${F5_CDN_SVN_ROOT}/cloudsolutions/${CDN_FOLDER} ${AUTH_OPTS}
        - curl -k -H "PRIVATE-TOKEN:${DAILY_TEST_TOKEN}" "https://${GITLAB_URL}/api/v4/projects/${CI_PROJECT_ID}/repository/branches" | jq -r .[].name > branches.txt
        - cat branches.txt
        - ls ${CDN_FOLDER}/develop > cdn_branches.txt
        - cat cdn_branches.txt
        - diff=$(comm -23 cdn_branches.txt branches.txt)
        - echo "Removing directories:$diff"
        - cd ${CDN_FOLDER}/develop
        - for d in $diff; do svn rm $d; done
        - changed_files_count=$(svn diff --summarize | wc -l)
        - if [[ $changed_files_count -ge 1 ]]; then svn commit -m "F5 automation templates project automation - ${CI_COMMIT_REF_NAME}" ${AUTH_OPTS}; else echo "Develop directories unchanged"; fi

    tags:
        - cm-official-docker-executor

# Cleanup artifactory images when matching branch no longer present on gitlab
cleanup_artifactory_images:
    stage: process
    only:
        variables:
            - $CLEANUP_ARTIFACTORY == "true"
    except:
        variables:
            - $RUN_FUNCTIONAL_TESTS == "true"
    script:
        # install jq
        - apt-get update
        - apt-get install -y jq
        # find branches in project and images in artifactory
        - curl -k -H "PRIVATE-TOKEN:${DAILY_TEST_TOKEN}" "https://${GITLAB_URL}/api/v4/projects/${CI_PROJECT_ID}/repository/branches" | jq -r .[].name > branches.txt
        - cat branches.txt
        - curl -k -u "${GITLAB_ARTIFACTORY_USER}:${GITLAB_ARTIFACTORY_PASSWORD}" -X GET "https://${ARTIFACTORY_SERVER}/artifactory/api/docker/ecosystems-cloudsolutions-docker-dev/v2/deployment-tool-runtime-init/tags/list" | jq -r .tags[] > artifactory_tags.txt
        - cat artifactory_tags.txt
        - diff=$(comm -23 artifactory_tags.txt branches.txt)
        - for d in $diff; do if [[ $d != "latest" ]]; then echo removing image ${d}; curl -k -u "${GITLAB_ARTIFACTORY_USER}:${GITLAB_ARTIFACTORY_PASSWORD}" -X DELETE "https://${ARTIFACTORY_SERVER}/artifactory/ecosystems-cloudsolutions-docker-dev/deployment-tool-runtime-init/${d}"; fi; done
    tags:
        - cm-official-docker-executor

# lint package
lint_package:
    stage: test
    script:
        # linter
        - npm install
        - npm run lint
    tags:
        - cm-official-docker-executor
    except:
        refs:
            - schedules
        variables:
            - $CLEANUP_DEVELOP_CDN == "true"

# audit packages for vulnerabilities
test_audit:
    stage: test
    script:
        # npm audit - uses custom audit processor wrapper
        - npm install --unsafe-perm
        - npm run audit
    tags:
        - cm-official-docker-executor
    except:
        refs:
            - schedules
        variables:
            - $CLEANUP_DEVELOP_CDN == "true"

# run unit tests --uncomment
unit_tests:
    stage: test
    script:
        - npm install --unsafe-perm
        - npm run test
    tags:
        - cm-official-docker-executor
    except:
        refs:
            - schedules
        variables:
            - $CLEANUP_DEVELOP_CDN == "true"

# check for disallowed content in all files, this supplements
# the native pre-receive push rules built into GitLab for secrets
# NOTE: .gitallowed is used for exceptions
check_content:
    image: ${ARTIFACTORY_SERVER}/dockerhub-remote/f5devcentral/containthedocs:rpmbuild
    stage: test
    script:
        # install git-secrets
        - curl -q -L -o git_secrets.tar.gz ${GIT_SECRETS_PKG_URL}
        - tar xzf git_secrets.tar.gz
        - cd git-secrets-${GIT_SECRETS_VERSION} && make install && cd ..
        # now, add any patterns to disallow
        - git secrets --add '.*f5.*\.com'
        # scan
        - git secrets --scan
    tags:
        - cm-official-docker-executor
    except:
        refs:
            - schedules

# generate README.md and SCHEMA.md
check_schema:
    stage: test
    script:
        - npm install --unsafe-perm
        - npm run generate-readmes
        - if git diff | grep 'diff --git'; then exit 1; else exit 0; fi
    tags:
        - cm-official-docker-executor
    except:
        refs:
            - schedules

# verifies all examples use the latest AT Components versions
check_at_components_metadata:
    stage: test
    image: ${ARTIFACTORY_SERVER}/dockerhub-remote/python:3
    script:
        - curl -sL https://deb.nodesource.com/setup_12.x | bash - && apt-get install -yq nodejs build-essential
        - npm install -g npm
        - apt-get install -y jq
        - pip3 install yq
        - npm run sync-at-components-metadata
        - if git diff | grep 'diff --git'; then exit 1; else exit 0; fi
    tags:
        - cm-official-docker-executor
    except:
        refs:
            - schedules

# checks links in README
check_links:
    image: ${ARTIFACTORY_SERVER}/dockerhub-remote/node:10
    stage: test
    script:
        - validate make link_check
    tags:
        - cm-official-docker-executor
    except:
        refs:
            - schedules

# build package
build_package:
    stage: build
    script:
        # install packages: jq, rpm
        - apt-get update
        - apt-get install -y jq
        - apt-get install -y rpm
        # install node dependencies
        - npm install
        # build package artifact
        - npm run build
    tags:
        - cm-official-docker-executor
    artifacts:
        name: package
        paths:
            - node_modules
            - dist
        expire_in: 1 week
    except:
        variables:
            - $CLEANUP_DEVELOP_CDN == "true"

### Functional Tests Section
# Publish docker image to artifactory
publish_container:
    image: ${ARTIFACTORY_SERVER}/dockerhub-remote/docker:stable
    stage: functional_test_publish
    script:
        - docker login -u ${GITLAB_ARTIFACTORY_USER} -p ${GITLAB_ARTIFACTORY_PASSWORD} ${ARTIFACTORY_SERVER}
        - docker build --build-arg artifactory_server=${ARTIFACTORY_SERVER} -t ${ARTIFACTORY_SERVER}/ecosystems-cloudsolutions-docker-dev/deployment-tool-runtime-init:${CI_COMMIT_REF_NAME} .
        - docker push ${ARTIFACTORY_SERVER}/ecosystems-cloudsolutions-docker-dev/deployment-tool-runtime-init:${CI_COMMIT_REF_NAME}
    tags:
        - docker-executor
    only:
        variables:
            - $CI_COMMIT_REF_NAME == "main"
            - $CI_COMMIT_REF_NAME == "develop"
            - $RUN_FUNCTIONAL_TESTS == "true"
            - $CI_COMMIT_MESSAGE =~ /smart:run_functional_tests/
        changes:
            - Dockerfile
            - plans/**/*
    except:
        variables:
            - $CLEANUP_DEVELOP_CDN == "true"

# Functional Tests - Initialization phase (with 1 retries in a case of any failures)
.test_functional_init_generic: &test_functional_init_generic
    stage: functional_test_init
    image: ${ARTIFACTORY_SERVER}/ecosystems-cloudsolutions-docker-dev/deployment-tool-runtime-init:${CI_COMMIT_REF_NAME}
    retry:
        max: 1
    script:
        - current_dir=$(pwd)
        - echo "*** Configuring SSH"
        - eval $(ssh-agent -s)
        - echo "$SSH_KEY" | sed 's/\\n/\n/g' | ssh-add -
        - mkdir -p ~/.ssh
        - chmod 700 ~/.ssh
        # - printf '%s\n' '${SSH_KEY}' >> dewpt.pem
        # - chmod 600 dewpt.pem
        # deploy hashicorp vault and exit out of the folder
        - cd /deployment-tool/plans/vault/aws
        - terraform init
        - terraform apply -auto-approve
        - cd $current_dir
        # sleep
        - sleep 3m
        # get Hashicorp vault details and place them in user_data file
        - export VAULT_MGMT_IP=$(cat /deployment-tool/plans/vault/aws/terraform.tfstate | jq .outputs.vault_server_public_ip.value -r)
        - export VAULT_SERVER_PUBLIC_HTTP=$(cat /deployment-tool/plans/vault/aws/terraform.tfstate | jq .outputs.vault_server_public_http.value -r)
        - export VAULT_APP_ROLE=$(ssh -l ubuntu $VAULT_MGMT_IP -o 'StrictHostKeyChecking=no' 'cat /tmp/role-id | jq -r .data.role_id')
        - export VAULT_SECRET_ID=$(ssh -l ubuntu $VAULT_MGMT_IP -o 'StrictHostKeyChecking=no' 'cat /tmp/secret-id | jq -r .data.secret_id')
        - export VAULT_WRAPPED_SECRET_ID=$(ssh -l ubuntu $VAULT_MGMT_IP -o 'StrictHostKeyChecking=no' 'cat /tmp/wrapped-secret-id | jq -r .wrap_info.token')
        - export VAULT_WRAPPED_SECRET_ID_2=$(ssh -l ubuntu $VAULT_MGMT_IP -o 'StrictHostKeyChecking=no' 'cat /tmp/wrapped-secret-id-2 | jq -r .wrap_info.token')
        # debugging the values
        - echo $VAULT_MGMT_IP
        - echo $VAULT_SERVER_PUBLIC_HTTP
        - echo $VAULT_APP_ROLE
        - echo $VAULT_SECRET_ID
        - echo $VAULT_WRAPPED_SECRET_ID
        - echo $VAULT_WRAPPED_SECRET_ID_2
        - sed -i "s \vault_server_public_http $VAULT_SERVER_PUBLIC_HTTP g" /deployment-tool/plans/${CLOUD}/user_data.tpl
        - sed -i "s/\vault_app_role/$VAULT_APP_ROLE/g" /deployment-tool/plans/${CLOUD}/user_data.tpl
        - sed -i "s/\vault_secret_id/$VAULT_SECRET_ID/g" /deployment-tool/plans/${CLOUD}/user_data.tpl
        - sed -i "s/\vault_wrapped_secret_id/$VAULT_WRAPPED_SECRET_ID/g" /deployment-tool/plans/${CLOUD}/user_data.tpl
        # deploy environment - required artifacts will be place in output folder
        - /deployment-tool/deploy.sh --deployment-plan ${CLOUD} --action create --output-folder env_metadata/${CLOUD}_${TF_VAR_DOMAIN}/${VERSION_PATH}
        # Collecting deployment metadata
        - grep "\-\-\-" /deployment-tool/plans/${CLOUD}/user_data.tpl -A 1000 > env_metadata/${CLOUD}_${TF_VAR_DOMAIN}/${VERSION_PATH}/f5-bigip-runtime-declaration.yaml
        - export MGMT_IP=$(cat env_metadata/${CLOUD}_${TF_VAR_DOMAIN}/${VERSION_PATH}/deployment_info.json | jq .instances[].mgmt_address -r)
        - export USERNAME=$(cat env_metadata/${CLOUD}_${TF_VAR_DOMAIN}/${VERSION_PATH}/deployment_info.json | jq .instances[].admin_username -r)
        - export PASSWORD=$(cat env_metadata/${CLOUD}_${TF_VAR_DOMAIN}/${VERSION_PATH}/deployment_info.json | jq .instances[].admin_password -r)
        - export DEPLOYMENT_ID=$(cat env_metadata/${CLOUD}_${TF_VAR_DOMAIN}/${VERSION_PATH}/deployment_info.json | jq .deploymentId -r)
        - export SECRET_ID=$(cat env_metadata/${CLOUD}_${TF_VAR_DOMAIN}/${VERSION_PATH}/deployment_info.json | jq .secret_id -r)
        - export NAME=$(cat package.json | jq .name -r)
        - export VERSION=$(cat package.json | jq -r ".version")
        - export RELEASE=$(cat package.json | jq -r ".release")
        - echo "Verifying that BIGIP is ready to accept commands"
        - bash tests/scripts/verify_bash_available.sh
        - if [[ $? != 0 ]]; then exit 1; fi
        - echo "Installing RPM and executing"
        - sshpass -p $PASSWORD scp -o StrictHostKeyChecking=no dist/f5-bigip-runtime-init-$VERSION-$RELEASE.gz.run $USERNAME@$MGMT_IP:/var/tmp/
        # Workaround: copying over declaration to support bigip version with no user-data support
        - sed "s/\${deployment_id}/$DEPLOYMENT_ID/g" env_metadata/${CLOUD}_${TF_VAR_DOMAIN}/${VERSION_PATH}/f5-bigip-runtime-declaration.yaml > env_metadata/${CLOUD}_${TF_VAR_DOMAIN}/${VERSION_PATH}/f5-bigip-runtime-declaration_replaced01.yaml
        - sed "s/\${secret_id}/$SECRET_ID/g" env_metadata/${CLOUD}_${TF_VAR_DOMAIN}/${VERSION_PATH}/f5-bigip-runtime-declaration_replaced01.yaml > env_metadata/${CLOUD}_${TF_VAR_DOMAIN}/${VERSION_PATH}/f5-bigip-runtime-declaration_replaced02.yaml
        - sed "s/\${domain}/$TF_VAR_DOMAIN/g" env_metadata/${CLOUD}_${TF_VAR_DOMAIN}/${VERSION_PATH}/f5-bigip-runtime-declaration_replaced02.yaml > env_metadata/${CLOUD}_${TF_VAR_DOMAIN}/${VERSION_PATH}/f5-bigip-runtime-declaration_replaced03.yaml
        - rm env_metadata/${CLOUD}_${TF_VAR_DOMAIN}/${VERSION_PATH}/f5-bigip-runtime-declaration.yaml && rm env_metadata/${CLOUD}_${TF_VAR_DOMAIN}/${VERSION_PATH}/f5-bigip-runtime-declaration_replaced01.yaml && rm env_metadata/${CLOUD}_${TF_VAR_DOMAIN}/${VERSION_PATH}/f5-bigip-runtime-declaration_replaced02.yaml
        - mv env_metadata/${CLOUD}_${TF_VAR_DOMAIN}/${VERSION_PATH}/f5-bigip-runtime-declaration_replaced03.yaml env_metadata/${CLOUD}_${TF_VAR_DOMAIN}/${VERSION_PATH}/f5-bigip-runtime-declaration.yaml
        - cat env_metadata/${CLOUD}_${TF_VAR_DOMAIN}/${VERSION_PATH}/f5-bigip-runtime-declaration.yaml
        - sshpass -p $PASSWORD scp -o StrictHostKeyChecking=no env_metadata/${CLOUD}_${TF_VAR_DOMAIN}/${VERSION_PATH}/f5-bigip-runtime-declaration.yaml $USERNAME@$MGMT_IP:/config/cloud/onboard_config
        # End of Workaround.
        - sshpass -p $PASSWORD scp -o StrictHostKeyChecking=no dist/f5-bigip-runtime-init-$VERSION-$RELEASE.gz.run $USERNAME@$MGMT_IP:/var/tmp/
        - sshpass -p $PASSWORD ssh -o StrictHostKeyChecking=no $USERNAME@$MGMT_IP "bash /var/tmp/f5-bigip-runtime-init-$VERSION-$RELEASE.gz.run -- '--cloud ${CLOUD} --toolchain-metadata-file-url https://f5-cft.s3.amazonaws.com/invalid.json --telemetry-params testKey01:testValue01,testKey02:testValue02'"
        - sshpass -p $PASSWORD ssh -o StrictHostKeyChecking=no $USERNAME@$MGMT_IP "bash f5-bigip-runtime-init -c /config/cloud/onboard_config"
        # Attempt to re-run self-executable and runtime-init
        # Using updated config because wrapped Vault token can only be used once
        - sed "s/${VAULT_WRAPPED_SECRET_ID}/${VAULT_WRAPPED_SECRET_ID_2}/g" env_metadata/${CLOUD}_${TF_VAR_DOMAIN}/${VERSION_PATH}/f5-bigip-runtime-declaration.yaml > env_metadata/${CLOUD}_${TF_VAR_DOMAIN}/${VERSION_PATH}/f5-bigip-runtime-declaration-update.yaml
        - cat env_metadata/${CLOUD}_${TF_VAR_DOMAIN}/${VERSION_PATH}/f5-bigip-runtime-declaration-update.yaml
        - sshpass -p $PASSWORD scp -o StrictHostKeyChecking=no env_metadata/${CLOUD}_${TF_VAR_DOMAIN}/${VERSION_PATH}/f5-bigip-runtime-declaration-update.yaml $USERNAME@$MGMT_IP:/config/cloud/onboard_config_update
        - sshpass -p $PASSWORD ssh -o StrictHostKeyChecking=no $USERNAME@$MGMT_IP "bash /var/tmp/f5-bigip-runtime-init-$VERSION-$RELEASE.gz.run -- '--cloud ${CLOUD} --skip-verify --skip-toolchain-metadata-sync'"
        - sshpass -p $PASSWORD ssh -o StrictHostKeyChecking=no $USERNAME@$MGMT_IP "bash f5-bigip-runtime-init -c /config/cloud/onboard_config_update --skip-telemetry"
    tags:
        - cm-official-docker-executor
    only:
        variables:
            - $CI_COMMIT_REF_NAME == "main"
            - $CI_COMMIT_REF_NAME == "develop"
            - $RUN_FUNCTIONAL_TESTS == "true"
            - $CI_COMMIT_MESSAGE =~ /smart:run_functional_tests/
    except:
        variables:
            - $CLEANUP_DEVELOP_CDN == "true"
            - $PUBLISH_RPM == "true"
    artifacts:
        paths:
            - env_metadata/${CLOUD}_${TF_VAR_DOMAIN}/${VERSION_PATH}
        when: always
        expire_in: 1 week

# run functional tests: azure and BIGIPv15
test_functional_init_azure_v15:
    <<: *test_functional_init_generic
    only:
        variables:
            - $TEST_SUITE == "all" && $BIGIP_VERSION == "15"
            - $TEST_SUITE == "all" && $BIGIP_VERSION == "all"
            - $TEST_SUITE == "azure" && $BIGIP_VERSION == "15"
    variables:
        CLOUD: "azure"
        TF_VAR_DOMAIN: "$CLOUD"
        TF_VAR_AZURE_BIGIP_VERSION: "$AZURE_BIGIP_VERSION_v15"
        VERSION_PATH: "v15"
    except:
        variables:
            - $TEST_SUITE == "gcp"
            - $TEST_SUITE == "aws"
            - $TEST_SUITE == "azure_gov"
            - $TEST_SUITE == "base"

# run functional tests: azure and BIGIPv14
test_functional_init_azure_v14:
    <<: *test_functional_init_generic
    only:
        variables:
            - $TEST_SUITE == "all" && $BIGIP_VERSION == "14"
            - $TEST_SUITE == "all" && $BIGIP_VERSION == "all"
            - $TEST_SUITE == "azure" && $BIGIP_VERSION == "14"
    variables:
        CLOUD: "azure"
        TF_VAR_DOMAIN: "$CLOUD"
        TF_VAR_AZURE_BIGIP_VERSION: "$AZURE_BIGIP_VERSION_v14"
        VERSION_PATH: "v14"
    except:
        variables:
            - $TEST_SUITE == "gcp"
            - $TEST_SUITE == "aws"
            - $TEST_SUITE == "azure_gov"
            - $TEST_SUITE == "base"

# run functional tests: azure and BIGIPv15
test_functional_init_azure_gov_v15:
    <<: *test_functional_init_generic
    only:
        variables:
            - $TEST_SUITE == "all" && $BIGIP_VERSION == "15"
            - $TEST_SUITE == "all" && $BIGIP_VERSION == "all"
            - $TEST_SUITE == "azure_gov" && $BIGIP_VERSION == "15"
    variables:
        CLOUD: "azure"
        TF_VAR_AZURE_BIGIP_VERSION: "$AZURE_BIGIP_VERSION_v15"
        VERSION_PATH: "v15"
        TF_VAR_DOMAIN: "usgovcloudapi"
        TF_VAR_location: "usgovvirginia"
        TF_VAR_AZURE_ENVIROMENT: "usgovernment"
        TF_VAR_AZURE_OBJECT_ID: "$AZURE_GOV_OBJECT_ID"
        TF_VAR_AZURE_TENANT_ID: "$AZURE_GOV_TENANT_ID"
        ARM_CLIENT_ID: "$AZURE_GOV_CLIENT_ID"
        ARM_CLIENT_SECRET: "$AZURE_GOV_CLIENT_SECRET"
        ARM_SUBSCRIPTION_ID: "$AZURE_GOV_SUBSCRIPTION_ID"
        ARM_TENANT_ID: "$AZURE_GOV_TENANT_ID"
    except:
        variables:
            - $TEST_SUITE == "gcp"
            - $TEST_SUITE == "aws"
            - $TEST_SUITE == "azure"
            - $TEST_SUITE == "base"

# run functional tests: azure and BIGIPv14
test_functional_init_azure_gov_v14:
    <<: *test_functional_init_generic
    only:
        variables:
            - $TEST_SUITE == "all" && $BIGIP_VERSION == "14"
            - $TEST_SUITE == "all" && $BIGIP_VERSION == "all"
            - $TEST_SUITE == "azure_gov" && $BIGIP_VERSION == "14"
    variables:
        CLOUD: "azure"
        TF_VAR_AZURE_BIGIP_VERSION: "$AZURE_BIGIP_VERSION_v15"
        VERSION_PATH: "v14"
        TF_VAR_DOMAIN: "usgovcloudapi"
        TF_VAR_location: "usgovvirginia"
        TF_VAR_AZURE_ENVIROMENT: "usgovernment"
        TF_VAR_AZURE_OBJECT_ID: "$AZURE_GOV_OBJECT_ID"
        TF_VAR_AZURE_TENANT_ID: "$AZURE_GOV_TENANT_ID"
        ARM_CLIENT_ID: "$AZURE_GOV_CLIENT_ID"
        ARM_CLIENT_SECRET: "$AZURE_GOV_CLIENT_SECRET"
        ARM_SUBSCRIPTION_ID: "$AZURE_GOV_SUBSCRIPTION_ID"
        ARM_TENANT_ID: "$AZURE_GOV_TENANT_ID"
    except:
        variables:
            - $TEST_SUITE == "gcp"
            - $TEST_SUITE == "aws"
            - $TEST_SUITE == "azure"
            - $TEST_SUITE == "base"


# run functional tests: aws and BIGIPv15
test_functional_init_aws_v15:
    <<: *test_functional_init_generic
    only:
        variables:
            - $TEST_SUITE == "all" && $BIGIP_VERSION == "15"
            - $TEST_SUITE == "all" && $BIGIP_VERSION == "all"
            - $TEST_SUITE == "aws" && $BIGIP_VERSION == "15"
    variables:
        CLOUD: "aws"
        TF_VAR_AWS_BIGIP_AMI_ID: "$AWS_BIGIP_AMI_ID_v15"
        VERSION_PATH: "v15"
    except:
        variables:
            - $TEST_SUITE == "azure"
            - $TEST_SUITE == "gcp"
            - $TEST_SUITE == "azure_gov"
            - $TEST_SUITE == "base"

# run functional tests: aws and BIGIPv14
test_functional_init_aws_v14:
    <<: *test_functional_init_generic
    only:
        variables:
            - $TEST_SUITE == "all" && $BIGIP_VERSION == "14"
            - $TEST_SUITE == "all" && $BIGIP_VERSION == "all"
            - $TEST_SUITE == "aws" && $BIGIP_VERSION == "14"
    variables:
        CLOUD: "aws"
        TF_VAR_AWS_BIGIP_AMI_ID: "$AWS_BIGIP_AMI_ID_v14"
        VERSION_PATH: "v14"
    except:
        variables:
            - $TEST_SUITE == "azure"
            - $TEST_SUITE == "gcp"
            - $TEST_SUITE == "azure_gov"
            - $TEST_SUITE == "base"

# run functional tests: gcp and BIGIPv15
test_functional_init_gcp_v15:
    <<: *test_functional_init_generic
    only:
        variables:
            - $TEST_SUITE == "all" && $BIGIP_VERSION == "15"
            - $TEST_SUITE == "all" && $BIGIP_VERSION == "all"
            - $TEST_SUITE == "gcp" && $BIGIP_VERSION == "15"
    variables:
        CLOUD: "gcp"
        TF_VAR_bigip_version: "$GOOGLE_BIGIP_VERSION_v15"
        VERSION_PATH: "v15"
    except:
        variables:
            - $TEST_SUITE == "azure"
            - $TEST_SUITE == "aws"
            - $TEST_SUITE == "azure_gov"
            - $TEST_SUITE == "base"

# run functional tests: gcp and BIGIPv14
test_functional_init_gcp_v14:
    <<: *test_functional_init_generic
    only:
        variables:
            - $TEST_SUITE == "all" && $BIGIP_VERSION == "14"
            - $TEST_SUITE == "all" && $BIGIP_VERSION == "all"
            - $TEST_SUITE == "gcp" && $BIGIP_VERSION == "14"
    variables:
        CLOUD: "gcp"
        TF_VAR_bigip_version: "$GOOGLE_BIGIP_VERSION_v14"
        VERSION_PATH: "v14"
    except:
        variables:
            - $TEST_SUITE == "azure"
            - $TEST_SUITE == "aws"
            - $TEST_SUITE == "azure_gov"
            - $TEST_SUITE == "base"

# run functional tests: base package and BIGIPv15
test_functional_init_base_v15:
    <<: *test_functional_init_generic
    only:
        variables:
            - $TEST_SUITE == "all" && $BIGIP_VERSION == "15"
            - $TEST_SUITE == "all" && $BIGIP_VERSION == "all"
            - $TEST_SUITE == "base" && $BIGIP_VERSION == "15"
    variables:
        CLOUD: "base"
        TF_VAR_bigip_version: "$GOOGLE_BIGIP_VERSION_v15"
        VERSION_PATH: "v15"
    except:
        variables:
            - $TEST_SUITE == "azure"
            - $TEST_SUITE == "aws"
            - $TEST_SUITE == "azure_gov"
            - $TEST_SUITE == "gcp"

# run functional tests: base package and BIGIPv15
test_functional_init_base_v14:
    <<: *test_functional_init_generic
    only:
        variables:
            - $TEST_SUITE == "all" && $BIGIP_VERSION == "14"
            - $TEST_SUITE == "all" && $BIGIP_VERSION == "all"
            - $TEST_SUITE == "base" && $BIGIP_VERSION == "14"
    variables:
        CLOUD: "base"
        TF_VAR_bigip_version: "$GOOGLE_BIGIP_VERSION_v14"
        VERSION_PATH: "v14"
    except:
        variables:
            - $TEST_SUITE == "azure"
            - $TEST_SUITE == "aws"
            - $TEST_SUITE == "azure_gov"
            - $TEST_SUITE == "gcp"

# Functional Tests - Execute phase (with no retries)
.test_functional_execute_generic: &test_functional_execute_generic
    stage: functional_test_execute
    image: ${ARTIFACTORY_SERVER}/dockerhub-remote/python:3.7
    script:
        # install jq
        - apt-get update
        - apt-get install -y jq
        # install sshpass
        - apt-get install sshpass
        # install node (and package dependencies )
        - curl -sL https://deb.nodesource.com/setup_12.x | bash - && apt-get -y install nodejs
        - npm install
        # copying artifacts inherited from functional_test_init target to root directory
        - cp -a env_metadata/${CLOUD}_${TF_VAR_DOMAIN}/${VERSION_PATH}/. .
        # executing fuctional test
        - validate npm run functional-test
    tags:
        - cm-official-docker-executor
    only:
        variables:
            - $CI_COMMIT_REF_NAME == "main"
            - $CI_COMMIT_REF_NAME == "develop"
            - $RUN_FUNCTIONAL_TESTS == "true"
            - $CI_COMMIT_MESSAGE =~ /smart:run_functional_tests/
    except:
        variables:
            - $CLEANUP_DEVELOP_CDN == "true"
            - $PUBLISH_RPM == "true"
    artifacts:
        paths:
            - logs
        when: always
        expire_in: 1 week

# run functional tests: azure
test_functional_execute_azure_v15:
    <<: *test_functional_execute_generic
    only:
        variables:
            - $TEST_SUITE == "all" && $BIGIP_VERSION == "15"
            - $TEST_SUITE == "all" && $BIGIP_VERSION == "all"
            - $TEST_SUITE == "azure" && $BIGIP_VERSION == "15"
    variables:
        CLOUD: "azure"
        TF_VAR_DOMAIN: "$CLOUD"
        VERSION_PATH: "v15"
        AZURE_CLIENT_ID: "$AZURE_COMMERCIAL_CLIENT_ID"
        AZURE_CLIENT_SECRET: "$AZURE_COMMERCIAL_CLIENT_SECRET"
        AZURE_TENANT_ID: "$AZURE_COMMERCIAL_TENANT_ID"
        AZURE_SUBSCRIPTION_ID: "$AZURE_COMMERCIAL_SUBSCRIPTION_ID"
    except:
        variables:
            - $TEST_SUITE == "gcp"
            - $TEST_SUITE == "aws"
            - $TEST_SUITE == "azure_gov"
            - $TEST_SUITE == "base"
    dependencies:
        - test_functional_init_azure_v15
        - build_package

# run functional tests: azure
test_functional_execute_azure_v14:
    <<: *test_functional_execute_generic
    only:
        variables:
            - $TEST_SUITE == "all" && $BIGIP_VERSION == "14"
            - $TEST_SUITE == "all" && $BIGIP_VERSION == "all"
            - $TEST_SUITE == "azure" && $BIGIP_VERSION == "14"
    variables:
        CLOUD: "azure"
        TF_VAR_DOMAIN: "$CLOUD"
        VERSION_PATH: "v14"
        AZURE_CLIENT_ID: "$AZURE_COMMERCIAL_CLIENT_ID"
        AZURE_CLIENT_SECRET: "$AZURE_COMMERCIAL_CLIENT_SECRET"
        AZURE_TENANT_ID: "$AZURE_COMMERCIAL_TENANT_ID"
        AZURE_SUBSCRIPTION_ID: "$AZURE_COMMERCIAL_SUBSCRIPTION_ID"
    except:
        variables:
            - $TEST_SUITE == "gcp"
            - $TEST_SUITE == "aws"
            - $TEST_SUITE == "azure_gov"
            - $TEST_SUITE == "base"
    dependencies:
        - test_functional_init_azure_v14
        - build_package

# run functional tests: azure goverment
test_functional_execute_azure_gov_v15:
    <<: *test_functional_execute_generic
    only:
        variables:
            - $TEST_SUITE == "all" && $BIGIP_VERSION == "15"
            - $TEST_SUITE == "all" && $BIGIP_VERSION == "all"
            - $TEST_SUITE == "azure_gov" && $BIGIP_VERSION == "15"
    variables:
        CLOUD: "azure"
        VERSION_PATH: "v15"
        TF_VAR_DOMAIN: "usgovcloudapi"
        TF_VAR_AZURE_ENVIROMENT: "usgovernment"
        TF_VAR_AZURE_OBJECT_ID: "$AZURE_GOV_OBJECT_ID"
        TF_VAR_AZURE_TENANT_ID: "$AZURE_GOV_TENANT_ID"
        AZURE_CLIENT_ID: "$AZURE_GOV_CLIENT_ID"
        AZURE_CLIENT_SECRET: "$AZURE_GOV_CLIENT_SECRET"
        AZURE_TENANT_ID: "$AZURE_GOV_TENANT_ID"
        AZURE_SUBSCRIPTION_ID: "$AZURE_GOV_SUBSCRIPTION_ID"
    except:
        variables:
            - $TEST_SUITE == "gcp"
            - $TEST_SUITE == "aws"
            - $TEST_SUITE == "azure"
            - $TEST_SUITE == "base"
    dependencies:
        - test_functional_init_azure_gov_v15
        - build_package

# run functional tests: azure
test_functional_execute_azure_gov_v14:
    <<: *test_functional_execute_generic
    only:
        variables:
            - $TEST_SUITE == "all" && $BIGIP_VERSION == "14"
            - $TEST_SUITE == "all" && $BIGIP_VERSION == "all"
            - $TEST_SUITE == "azure_gov" && $BIGIP_VERSION == "14"
    variables:
        CLOUD: "azure"
        VERSION_PATH: "v14"
        TF_VAR_DOMAIN: "usgovcloudapi"
        TF_VAR_AZURE_ENVIROMENT: "usgovernment"
        TF_VAR_AZURE_OBJECT_ID: "$AZURE_GOV_OBJECT_ID"
        TF_VAR_AZURE_TENANT_ID: "$AZURE_GOV_TENANT_ID"
        AZURE_CLIENT_ID: "$AZURE_GOV_CLIENT_ID"
        AZURE_CLIENT_SECRET: "$AZURE_GOV_CLIENT_SECRET"
        AZURE_TENANT_ID: "$AZURE_GOV_TENANT_ID"
        AZURE_SUBSCRIPTION_ID: "$AZURE_GOV_SUBSCRIPTION_ID"
    except:
        variables:
            - $TEST_SUITE == "gcp"
            - $TEST_SUITE == "aws"
            - $TEST_SUITE == "azure"
            - $TEST_SUITE == "base"
    dependencies:
        - test_functional_init_azure_gov_v14
        - build_package


# run functional tests: aws
test_functional_execute_aws_v15:
    <<: *test_functional_execute_generic
    only:
        variables:
            - $TEST_SUITE == "all" && $BIGIP_VERSION == "15"
            - $TEST_SUITE == "all" && $BIGIP_VERSION == "all"
            - $TEST_SUITE == "aws" && $BIGIP_VERSION == "15"
    variables:
        CLOUD: "aws"
        VERSION_PATH: "v15"
    except:
        variables:
            - $TEST_SUITE == "gcp"
            - $TEST_SUITE == "azure"
            - $TEST_SUITE == "azure_gov"
            - $TEST_SUITE == "base"
    dependencies:
        - test_functional_init_aws_v15
        - build_package


test_functional_execute_aws_v14:
    <<: *test_functional_execute_generic
    only:
        variables:
            - $TEST_SUITE == "all" && $BIGIP_VERSION == "14"
            - $TEST_SUITE == "all" && $BIGIP_VERSION == "all"
            - $TEST_SUITE == "aws" && $BIGIP_VERSION == "14"
    variables:
        CLOUD: "aws"
        VERSION_PATH: "v14"
    except:
        variables:
            - $TEST_SUITE == "gcp"
            - $TEST_SUITE == "azure"
            - $TEST_SUITE == "azure_gov"
            - $TEST_SUITE == "base"
    dependencies:
        - test_functional_init_aws_v14
        - build_package

# run functional tests: gcp
test_functional_execute_gcp_v15:
    <<: *test_functional_execute_generic
    only:
        variables:
            - $TEST_SUITE == "all" && $BIGIP_VERSION == "15"
            - $TEST_SUITE == "all" && $BIGIP_VERSION == "all"
            - $TEST_SUITE == "gcp" && $BIGIP_VERSION == "15"
    variables:
        CLOUD: "gcp"
        VERSION_PATH: "v15"
    except:
        variables:
            - $TEST_SUITE == "aws"
            - $TEST_SUITE == "azure"
            - $TEST_SUITE == "azure_gov"
            - $TEST_SUITE == "base"
    dependencies:
        - test_functional_init_gcp_v15
        - build_package

test_functional_execute_gcp_v14:
    <<: *test_functional_execute_generic
    only:
        variables:
            - $TEST_SUITE == "all" && $BIGIP_VERSION == "14"
            - $TEST_SUITE == "all" && $BIGIP_VERSION == "all"
            - $TEST_SUITE == "gcp" && $BIGIP_VERSION == "14"
    variables:
        CLOUD: "gcp"
        VERSION_PATH: "v14"
    except:
        variables:
            - $TEST_SUITE == "aws"
            - $TEST_SUITE == "azure"
            - $TEST_SUITE == "azure_gov"
            - $TEST_SUITE == "base"
    dependencies:
        - test_functional_init_gcp_v14
        - build_package

# run base package tests
test_functional_execute_base_v15:
    <<: *test_functional_execute_generic
    only:
        variables:
            - $TEST_SUITE == "all" && $BIGIP_VERSION == "15"
            - $TEST_SUITE == "all" && $BIGIP_VERSION == "all"
            - $TEST_SUITE == "base" && $BIGIP_VERSION == "15"
    variables:
        CLOUD: "base"
        VERSION_PATH: "v15"
        ENV_PROVIDER_TESTS: "ignore"
    except:
        variables:
            - $TEST_SUITE == "aws"
            - $TEST_SUITE == "azure"
            - $TEST_SUITE == "azure_gov"
            - $TEST_SUITE == "gcp"
    dependencies:
        - test_functional_init_base_v15
        - build_package

test_functional_execute_base_v14:
    <<: *test_functional_execute_generic
    only:
        variables:
            - $TEST_SUITE == "all" && $BIGIP_VERSION == "14"
            - $TEST_SUITE == "all" && $BIGIP_VERSION == "all"
            - $TEST_SUITE == "base" && $BIGIP_VERSION == "14"
    variables:
        CLOUD: "base"
        VERSION_PATH: "v14"
        ENV_PROVIDER_TESTS: "ignore"
    except:
        variables:
            - $TEST_SUITE == "aws"
            - $TEST_SUITE == "azure"
            - $TEST_SUITE == "azure_gov"
            - $TEST_SUITE == "gcp"
    dependencies:
        - test_functional_init_base_v14
        - build_package


# Functional Tests - Cleanup phase (executes always with 1 retry in a case of any failures)
.test_functional_cleanup_generic: &test_functional_cleanup_generic
    stage: functional_test_cleanup
    image: ${ARTIFACTORY_SERVER}/ecosystems-cloudsolutions-docker-dev/deployment-tool-runtime-init:${CI_COMMIT_REF_NAME}
    retry:
        max: 1
    when: always
    script:
        # copying artifacts inherited from functional_test_init target to root directory
        - cp -a env_metadata/${CLOUD}_${TF_VAR_DOMAIN}/${VERSION_PATH}/. .
        # teardown environment
        - /deployment-tool/deploy.sh --deployment-plan ${CLOUD} --action delete
    tags:
        - cm-official-docker-executor
    only:
        variables:
            - $CI_COMMIT_REF_NAME == "main"
            - $CI_COMMIT_REF_NAME == "develop"
            - $RUN_FUNCTIONAL_TESTS == "true"
            - $CI_COMMIT_MESSAGE =~ /smart:run_functional_tests/
    except:
        variables:
            - $CLEANUP_DEVELOP_CDN == "true"
            - $PUBLISH_RPM == "true"

# run functional tests: azure
test_functional_cleanup_azure_v15:
    <<: *test_functional_cleanup_generic
    only:
        variables:
            - $TEST_SUITE == "all" && $BIGIP_VERSION == "15"
            - $TEST_SUITE == "all" && $BIGIP_VERSION == "all"
            - $TEST_SUITE == "azure" && $BIGIP_VERSION == "15"
    variables:
        CLOUD: "azure"
        TF_VAR_DOMAIN: "$CLOUD"
        VERSION_PATH: "v15"
    except:
        variables:
            - $TEST_SUITE == "aws"
            - $TEST_SUITE == "gcp"
            - $TEST_SUITE == "azure_gov"
            - $TEST_SUITE == "base"
    dependencies:
        - test_functional_init_azure_v15


test_functional_cleanup_azure_v14:
    <<: *test_functional_cleanup_generic
    only:
        variables:
            - $TEST_SUITE == "all" && $BIGIP_VERSION == "14"
            - $TEST_SUITE == "all" && $BIGIP_VERSION == "all"
            - $TEST_SUITE == "azure" && $BIGIP_VERSION == "14"
    variables:
        CLOUD: "azure"
        TF_VAR_DOMAIN: "$CLOUD"
        VERSION_PATH: "v14"
    except:
        variables:
            - $TEST_SUITE == "aws"
            - $TEST_SUITE == "gcp"
            - $TEST_SUITE == "azure_gov"
            - $TEST_SUITE == "base"
    dependencies:
        - test_functional_init_azure_v14



# run functional tests: azure gov
test_functional_cleanup_azure_gov_v15:
    <<: *test_functional_cleanup_generic
    only:
        variables:
            - $TEST_SUITE == "all" && $BIGIP_VERSION == "15"
            - $TEST_SUITE == "all" && $BIGIP_VERSION == "all"
            - $TEST_SUITE == "azure_gov" && $BIGIP_VERSION == "15"
    variables:
        CLOUD: "azure"
        TF_VAR_AZURE_BIGIP_VERSION: "$AZURE_BIGIP_VERSION_v15"
        VERSION_PATH: "v15"
        TF_VAR_DOMAIN: "usgovcloudapi"
        TF_VAR_location: "usgovvirginia"
        TF_VAR_AZURE_ENVIROMENT: "usgovernment"
        TF_VAR_AZURE_OBJECT_ID: "$AZURE_GOV_OBJECT_ID"
        TF_VAR_AZURE_TENANT_ID: "$AZURE_GOV_TENANT_ID"
        ARM_CLIENT_ID: "$AZURE_GOV_CLIENT_ID"
        ARM_CLIENT_SECRET: "$AZURE_GOV_CLIENT_SECRET"
        ARM_SUBSCRIPTION_ID: "$AZURE_GOV_SUBSCRIPTION_ID"
        ARM_TENANT_ID: "$AZURE_GOV_TENANT_ID"
    except:
        variables:
            - $TEST_SUITE == "aws"
            - $TEST_SUITE == "gcp"
            - $TEST_SUITE == "azure"
            - $TEST_SUITE == "base"
    dependencies:
        - test_functional_init_azure_gov_v15


test_functional_cleanup_azure_gov_v14:
    <<: *test_functional_cleanup_generic
    only:
        variables:
            - $TEST_SUITE == "all" && $BIGIP_VERSION == "14"
            - $TEST_SUITE == "all" && $BIGIP_VERSION == "all"
            - $TEST_SUITE == "azure_gov" && $BIGIP_VERSION == "14"
    variables:
        CLOUD: "azure"
        TF_VAR_AZURE_BIGIP_VERSION: "$AZURE_BIGIP_VERSION_v15"
        VERSION_PATH: "v15"
        TF_VAR_DOMAIN: "usgovcloudapi"
        TF_VAR_location: "usgovvirginia"
        TF_VAR_AZURE_ENVIROMENT: "usgovernment"
        TF_VAR_AZURE_OBJECT_ID: "$AZURE_GOV_OBJECT_ID"
        TF_VAR_AZURE_TENANT_ID: "$AZURE_GOV_TENANT_ID"
        ARM_CLIENT_ID: "$AZURE_GOV_CLIENT_ID"
        ARM_CLIENT_SECRET: "$AZURE_GOV_CLIENT_SECRET"
        ARM_SUBSCRIPTION_ID: "$AZURE_GOV_SUBSCRIPTION_ID"
        ARM_TENANT_ID: "$AZURE_GOV_TENANT_ID"
    except:
        variables:
            - $TEST_SUITE == "aws"
            - $TEST_SUITE == "gcp"
            - $TEST_SUITE == "azure"
            - $TEST_SUITE == "base"
    dependencies:
        - test_functional_init_azure_gov_v14

# run functional tests: aws
test_functional_cleanup_aws_v15:
    <<: *test_functional_cleanup_generic
    only:
        variables:
            - $TEST_SUITE == "all" && $BIGIP_VERSION == "15"
            - $TEST_SUITE == "all" && $BIGIP_VERSION == "all"
            - $TEST_SUITE == "aws" && $BIGIP_VERSION == "15"
    variables:
        CLOUD: "aws"
        VERSION_PATH: "v15"
    except:
        variables:
            - $TEST_SUITE == "azure"
            - $TEST_SUITE == "gcp"
            - $TEST_SUITE == "azure_gov"
            - $TEST_SUITE == "base"
    dependencies:
        - test_functional_init_aws_v15

test_functional_cleanup_aws_v14:
    <<: *test_functional_cleanup_generic
    only:
        variables:
            - $TEST_SUITE == "all" && $BIGIP_VERSION == "14"
            - $TEST_SUITE == "all" && $BIGIP_VERSION == "all"
            - $TEST_SUITE == "aws" && $BIGIP_VERSION == "14"
    variables:
        CLOUD: "aws"
        VERSION_PATH: "v14"
    except:
        variables:
            - $TEST_SUITE == "azure"
            - $TEST_SUITE == "gcp"
            - $TEST_SUITE == "azure_gov"
            - $TEST_SUITE == "base"
    dependencies:
        - test_functional_init_aws_v14

# run functional tests: gcp
test_functional_cleanup_gcp_v15:
    <<: *test_functional_cleanup_generic
    only:
        variables:
            - $TEST_SUITE == "all" && $BIGIP_VERSION == "15"
            - $TEST_SUITE == "all" && $BIGIP_VERSION == "all"
            - $TEST_SUITE == "gcp" && $BIGIP_VERSION == "15"
    variables:
        CLOUD: "gcp"
        VERSION_PATH: "v15"
    except:
        variables:
            - $TEST_SUITE == "azure"
            - $TEST_SUITE == "aws"
            - $TEST_SUITE == "azure_gov"
            - $TEST_SUITE == "base"
    dependencies:
        - test_functional_init_gcp_v15

test_functional_cleanup_gcp_v14:
    <<: *test_functional_cleanup_generic
    only:
        variables:
            - $TEST_SUITE == "all" && $BIGIP_VERSION == "14"
            - $TEST_SUITE == "all" && $BIGIP_VERSION == "all"
            - $TEST_SUITE == "gcp" && $BIGIP_VERSION == "14"
    variables:
        CLOUD: "gcp"
        VERSION_PATH: "v14"
    except:
        variables:
            - $TEST_SUITE == "azure"
            - $TEST_SUITE == "aws"
            - $TEST_SUITE == "azure_gov"
            - $TEST_SUITE == "base"
    dependencies:
        - test_functional_init_gcp_v14


# run functional tests: base
test_functional_cleanup_base_v15:
    <<: *test_functional_cleanup_generic
    only:
        variables:
            - $TEST_SUITE == "all" && $BIGIP_VERSION == "15"
            - $TEST_SUITE == "all" && $BIGIP_VERSION == "all"
            - $TEST_SUITE == "base" && $BIGIP_VERSION == "15"
    variables:
        CLOUD: "base"
        VERSION_PATH: "v15"
    except:
        variables:
            - $TEST_SUITE == "azure"
            - $TEST_SUITE == "aws"
            - $TEST_SUITE == "azure_gov"
            - $TEST_SUITE == "gcp"
    dependencies:
        - test_functional_init_base_v15

test_functional_cleanup_base_v14:
    <<: *test_functional_cleanup_generic
    only:
        variables:
            - $TEST_SUITE == "all" && $BIGIP_VERSION == "14"
            - $TEST_SUITE == "all" && $BIGIP_VERSION == "all"
            - $TEST_SUITE == "base" && $BIGIP_VERSION == "14"
    variables:
        CLOUD: "base"
        VERSION_PATH: "v14"
    except:
        variables:
            - $TEST_SUITE == "azure"
            - $TEST_SUITE == "aws"
            - $TEST_SUITE == "azure_gov"
            - $TEST_SUITE == "gcp"
    dependencies:
        - test_functional_init_base_v14

# End of Funtional tests

# Publish RPM's to CDN
publish_rpms_dev_cdn:
    stage: publish
    only:
        variables:
            - $CI_COMMIT_REF_NAME == "develop"
            - $PUBLISH_RPM_DEVELOP == "true"
            - $CI_COMMIT_MESSAGE =~ /smart:run_publish_develop_cdn/
    except:
        variables:
            - $RUN_FUNCTIONAL_TESTS == "true"
            - $CLEANUP_DEVELOP_CDN == "true"
    script:
        # publish dist rpms to F5 CDN into develop directory
        # install jq
        - apt-get update
        - apt-get install -y jq
        # copy push rpms to cdn
        - VERSION=$(cat package.json | jq -r ".version")
        - RELEASE=$(cat package.json | jq -r ".release")
        - echo "Version:${VERSION}, Release:${RELEASE}"
        - CDN_FOLDER="f5-bigip-runtime-init"
        - AUTH_OPTS="--username ${CDN_SVC_ACCOUNT_USER} --password ${CDN_SVC_ACCOUNT_PWD} --non-interactive"
        - svn co ${F5_CDN_SVN_ROOT}/cloudsolutions/${CDN_FOLDER} ${AUTH_OPTS}
        - mkdir -p ${CDN_FOLDER}/develop/${CI_COMMIT_REF_NAME}
        - cp -r dist ${CDN_FOLDER}/develop/${CI_COMMIT_REF_NAME}
        - cd ${CDN_FOLDER}/develop
        - status=$(svn status)
        - echo "$status"
        - if echo "$status" | grep -F '?'; then svn add --force ${CI_COMMIT_REF_NAME}; else echo "No new directory to add"; fi
        - changed_files_count=$(svn diff --summarize | wc -l)
        - echo "$changed_files_count"
        - if [[ $changed_files_count -ge 1 ]]; then svn add --force ${CI_COMMIT_REF_NAME}/*; svn commit -m "F5 automation templates project automation - ${CI_COMMIT_REF_NAME}" ${AUTH_OPTS}; else echo "RPM files unchanged"; fi
    tags:
        - cm-official-docker-executor

publish_rpms_cdn:
    stage: release_publish
    only:
        - /(^publish-(\d+\.){1,2}(\d)-(\d+)?$)/
    script:
        # publish dist rpms to F5 CDN into $VERSION directory
        # install jq
        - apt-get update
        - apt-get install -y jq
        # copy push rpms to cdn
        - VERSION=$(cat package.json | jq -r ".version")
        - RELEASE=$(cat package.json | jq -r ".release")
        - echo "Version:${VERSION}, Release:${RELEASE}"
        - CDN_FOLDER="f5-bigip-runtime-init"
        - AUTH_OPTS="--username ${CDN_SVC_ACCOUNT_USER} --password ${CDN_SVC_ACCOUNT_PWD} --non-interactive"
        - svn co ${F5_CDN_SVN_ROOT}/cloudsolutions/${CDN_FOLDER} ${AUTH_OPTS}
        - mkdir -p ${CDN_FOLDER}/v${VERSION}
        - cp -r dist ${CDN_FOLDER}/v${VERSION}
        - cd ${CDN_FOLDER}
        - status=$(svn status)
        - if echo "$status" | grep -F '?'; then svn add --force v${VERSION}; else echo "No new directory to add"; fi
        - changed_files_count=$(svn diff --summarize | wc -l)
        - if [[ $changed_files_count -ge 1 ]]; then svn add --force v${VERSION}/*; svn commit -m "F5 automation templates project automation - ${CI_COMMIT_REF_NAME}" ${AUTH_OPTS}; else echo "RPM files unchanged"; fi
    tags:
        - cm-official-docker-executor

publish_to_github:
    stage: release_publish
    only:
      - /(^publish-(\d+\.){1,2}(\d)-(\d+)?$)/
    script:
        # install jq
        - apt-get update
        - apt-get install -y jq
        # Execute Release script to push source to github repo
        - ./scripts/publish_github.sh

trigger_downstream_templates_tests_azure:
    stage: release_trigger_template_tests
    only:
      - /(^publish-(\d+\.){1,2}(\d)-(\d+)?$)/
    variables:
        RELEASE_RUNTIME_INIT_TESTS: "true"
        VERSION: $CI_COMMIT_REF_NAME
    trigger:
        project: cloudsolutions/automation-templates/f5-azure-arm-templates-v2
        branch: main
trigger_downstream_templates_tests_aws:
    stage: release_trigger_template_tests
    only:
      - /(^publish-(\d+\.){1,2}(\d)-(\d+)?$)/
    variables:
        RELEASE_RUNTIME_INIT_TESTS: "true"
        VERSION: $CI_COMMIT_REF_NAME
    trigger:
        project: cloudsolutions/automation-templates/f5-aws-cloudformation-v2
        branch: main
